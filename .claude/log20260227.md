# 2026-02-27 Implementation Log

## CoreML モデル同期 (サーバー → iPad) 実装

### 新規ファイル
- `AnnottyHIL/Services/HIL/ModelSyncManager.swift` — `nonisolated actor` でモデル永続化・ZIP展開・バージョン管理

### 変更ファイル (Swift)
- `project.yml` — ZIPFoundation SPM 依存追加
- `HILServerClient.swift` — `downloadLatestModel()` 追加 (300s timeout)
- `UNetService.swift` — `ModelSource` enum、ダウンロードモデル優先ロード、`reloadModels()`、divisor を `models.count` ベース、modelSource に応じた正規化分岐
- `HILViewModel.swift` — `syncModel(canvasVM:)` (直接 `/models/latest` を叩くシンプル設計)、`isSyncingModel`/`syncError`
- `RightPanelView.swift` — Sync Model ボタン、モデルソースインジケータ (緑●Server / 橙●Built-in)
- `MainView.swift` — 新パラメータのワイヤリング

### 変更ファイル (サーバー)
- `server/convert_coreml.py` — `ct.ImageType` → `ct.TensorType` (入力)、`ct.TensorType(name="logits")` (出力)

### 解決した問題
1. **Sync が動かない**: `/status` の事前チェック不要 → 直接 `/models/latest` を叩く設計に簡素化
2. **AI Predict 出力名不一致**: サーバー変換に `outputs=[ct.TensorType(name="logits")]` 追加
3. **AI Predict 入力型不一致**: `ct.ImageType`(CVPixelBuffer必須) → `ct.TensorType`(MLMultiArray受付)
4. **正規化の違い**: Bundled(内部1/255あり) vs Downloaded(前処理なし) で分岐

### HIL Dashboard ローカル画像ハイライト
- `CanvasViewModel.localImageFileNames` プロパティ追加
- `HILDashboardView` に `localImageNames` パラメータ追加
- iPad にインポート済みの画像: シアン色の背景・アイコン・"On iPad" ラベル表示

### ビルド結果
- BUILD SUCCEEDED (generic/platform=iOS)
- 動作確認済み: Sync Model → AI Predict 成功
